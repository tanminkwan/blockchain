# DHT 기반 WebRTC 시그널링 매뉴얼

이 매뉴얼은 제공된 Python 스크립트를 사용하여 WebRTC 연결을 설정하기 위한 분산 해시 테이블(DHT) 기반 시그널링 메커니즘을 설정하고 사용하는 방법에 대한 종합적인 가이드를 제공합니다. 시스템은 세 가지 주요 구성 요소로 구성됩니다:

1. **DHT 서버 (`dht_server.py`)**: SDP(세션 설명 프로토콜) 오퍼 및 앤서를 저장하고 검색하기 위한 분산 해시 테이블을 관리합니다.
2. **오퍼러 (`offerer_dhttype.py`)**: SDP 오퍼를 생성하고 저장하여 WebRTC 연결을 시작합니다.
3. **앤서러 (`answerer_dhttype.py`)**: 오퍼를 수신하여 SDP 앤서를 생성하고 다시 DHT에 저장하여 응답합니다.

## 목차

1. [소개](#소개)
2. [사전 요구 사항](#사전-요구-사항)
3. [설치](#설치)
4. [구성](#구성)
5. [DHT 서버 실행](#dht-서버-실행)
6. [오퍼러 실행](#오퍼러-실행)
7. [앤서러 실행](#앤서러-실행)
8. [시그널링 프로세스 이해하기](#시그널링-프로세스-이해하기)
9. [커스터마이징](#커스터마이징)
10. [문제 해결](#문제-해결)
11. [결론](#결론)

---

## 소개

WebRTC(Web Real-Time Communication)는 브라우저 및 기타 클라이언트 간의 오디오, 비디오 및 데이터 공유를 위한 피어 투 피어 통신을 가능하게 합니다. 그러나 WebRTC 연결을 설정하려면 피어 간에 세션 설명(SDP)을 교환하기 위한 시그널링 메커니즘이 필요합니다. 전통적인 시그널링 방법은 WebSockets나 HTTP와 같은 서버를 사용합니다. 이 매뉴얼에서는 분산 해시 테이블(DHT)을 사용하여 시그널링을 구현하는 탈중앙화된 접근 방식을 소개하며, 이는 확장성과 안정성을 향상시킵니다.

## 사전 요구 사항

DHT 기반 시그널링 시스템을 설정하기 전에 다음이 준비되어 있어야 합니다:

- **운영 체제**: Windows, macOS 또는 Linux.
- **Python**: 버전 3.7 이상.
- **Python 패키지**: `kademlia`, `aiortc`, `asyncio`.

## 설치

### 1. Python 설치

Python 3.7 이상이 시스템에 설치되어 있는지 확인하세요. [공식 웹사이트](https://www.python.org/downloads/)에서 다운로드할 수 있습니다.

### 2. 가상 환경 생성 (선택 사항 권장)

가상 환경을 생성하면 의존성을 관리하고 충돌을 방지할 수 있습니다.

```bash
python -m venv webrtc-dht-env
source webrtc-dht-env/bin/activate  # Windows의 경우: webrtc-dht-env\Scripts\activate
```

### 3. 필수 패키지 설치

`pip`을 사용하여 필요한 Python 패키지를 설치합니다:

```bash
pip install kademlia aiortc asyncio
```

*참고: `asyncio`는 Python 3.7 이상에서 표준 라이브러리에 포함되어 있습니다.*

### 4. 스크립트 다운로드

제공된 스크립트(`dht_server.py`, `offerer_dhttype.py`, `answerer_dhttype.py`)를 원하는 디렉토리에 저장합니다. 예: `webrtc-dht-signaling/`

## 구성

### 1. DHT 서버 구성 (`dht_server.py`)

DHT 서버는 특정 포트에서 리스닝하고, 선택적으로 부트스트랩 노드에 연결합니다.

- **기본 포트**: `8468`
- **부트스트랩 노드**: 선택 사항으로, 여러 DHT 서버를 연결할 때 사용됩니다.

기본적으로 서버는 부트스트랩 노드에 연결하지 않고 포트 `8468`에서 실행됩니다.

### 2. 오퍼러 및 앤서러 구성

`offerer_dhttype.py`와 `answerer_dhttype.py` 스크립트는 모두 `127.0.0.1`(로컬호스트)와 포트 `8468`에서 실행 중인 DHT 서버에 연결하도록 설정되어 있습니다.

- **DHT 서버 호스트**: `127.0.0.1`
- **DHT 서버 포트**: `8468`
- **DHT 키**:
  - **오퍼 키**: `webrtc-offer`
  - **앤서 키**: `webrtc-answer`

DHT 서버가 다른 호스트나 포트에서 실행 중인 경우, 두 스크립트 모두에서 `DHT_SERVER_HOST`와 `DHT_SERVER_PORT` 변수를 적절히 업데이트해야 합니다.

## DHT 서버 실행

DHT 서버는 SDP 오퍼 및 앤서를 저장하고 검색하는 중앙 노드 역할을 합니다.

### 1. DHT 서버 시작

터미널 또는 명령 프롬프트를 열고 `dht_server.py`가 있는 디렉토리로 이동한 후 다음 명령을 실행합니다:

```bash
python dht_server.py
```

**출력:**

```
DHT Server running on port 8468
```

*명령줄 인수로 부트스트랩 노드가 제공되면, 서버는 해당 노드에 연결을 시도합니다.*

### 2. 여러 DHT 서버 실행 (선택 사항)

DHT의 내구성과 분산성을 향상시키기 위해 여러 DHT 서버를 실행할 수 있습니다. 추가 서버는 기존 서버에 부트스트랩 노드로 연결할 수 있습니다.

```bash
python dht_server.py 127.0.0.1:8468
```

*`127.0.0.1:8468`을 기존 DHT 서버의 호스트와 포트로 교체하세요.*

## 오퍼러 실행

오퍼러는 WebRTC 연결을 시작하여 SDP 오퍼를 생성하고 이를 DHT에 저장합니다.

### 1. 오퍼러 스크립트 실행

새 터미널 또는 명령 프롬프트를 열고 `offerer_dhttype.py`가 있는 디렉토리로 이동한 후 다음 명령을 실행합니다:

```bash
python offerer_dhttype.py
```

**출력:**

```
Offer SDP stored in DHT.
Waiting for Answer SDP in DHT...
Remote description set. WebRTC connection established.
Data channel 'chat' is open
Received message from Peer B: Hello from Peer B!
```

*오퍼러는 DHT에 앤서 SDP가 나타날 때까지 대기하며, 이를 통해 WebRTC 연결이 설정됩니다.*

### 2. 오퍼러 동작 커스터마이징

- **데이터 채널**: 오퍼러는 `"chat"`이라는 레이블의 데이터 채널을 생성합니다. 레이블을 변경하거나 추가 데이터 채널을 처리하도록 수정할 수 있습니다.
- **메시지 교환**: 데이터 채널이 열리면 오퍼러는 `"Hello from Peer A!"`를 보냅니다. 메시지를 커스터마이징하거나 더 복잡한 상호작용을 구현할 수 있습니다.

## 앤서러 실행

앤서러는 오퍼 SDP를 DHT에서 검색하여 SDP 앤서를 생성하고 이를 다시 DHT에 저장하여 응답합니다.

### 1. 앤서러 스크립트 실행

또 다른 터미널 또는 명령 프롬프트를 열고 `answerer_dhttype.py`가 있는 디렉토리로 이동한 후 다음 명령을 실행합니다:

```bash
python answerer_dhttype.py
```

**출력:**

```
Waiting for Offer SDP in DHT...
Remote description set. Creating Answer SDP...
Answer SDP stored in DHT.
WebRTC connection established.
Received message on 'chat': Hello from Peer A!
Data channel 'chat' is open
```

*앤서러는 DHT에서 오퍼 SDP가 나타날 때까지 대기하고, 이를 기반으로 앤서 SDP를 생성하여 WebRTC 연결을 설정합니다.*

### 2. 앤서러 동작 커스터마이징

- **데이터 채널 처리**: 앤서러는 `"chat"` 레이블의 데이터 채널을 수신 대기합니다. 레이블을 변경하거나 추가 데이터 채널을 처리하도록 수정할 수 있습니다.
- **메시지 교환**: 데이터 채널에서 메시지를 수신하면 앤서러는 `"Hello from Peer B!"`로 응답합니다. 애플리케이션에 맞게 커스터마이징할 수 있습니다.

## 시그널링 프로세스 이해하기

DHT 기반 시그널링 프로세스는 다음과 같은 단계로 진행됩니다:

1. **DHT 서버 초기화**: SDP 오퍼 및 앤서를 관리하기 위해 중앙 DHT 서버가 시작됩니다.
2. **오퍼러 초기화**:
   - WebRTC `RTCPeerConnection`을 생성합니다.
   - SDP 오퍼를 생성합니다.
   - 오퍼 SDP를 DHT의 `webrtc-offer` 키 아래에 저장합니다.
   - DHT에서 `webrtc-answer` 키 아래에 앤서 SDP가 나타날 때까지 대기합니다.
3. **앤서러 초기화**:
   - DHT 서버에 연결합니다.
   - DHT에서 `webrtc-offer` 키 아래에 오퍼 SDP가 나타날 때까지 대기합니다.
   - 오퍼 SDP를 검색하고 이를 원격 설명으로 설정합니다.
   - SDP 앤서를 생성하고 이를 DHT의 `webrtc-answer` 키 아래에 저장합니다.
4. **연결 설정**:
   - 오퍼러는 DHT에서 앤서 SDP를 검색합니다.
   - 앤서 SDP를 원격 설명으로 설정합니다.
   - WebRTC 연결이 설정되어 데이터 채널을 통한 데이터 교환이 가능해집니다.

**데이터 흐름 다이어그램:**

```
[오퍼러]
    |
    |--(DHT에 SDP 오퍼 저장: webrtc-offer)-->
    |
[DHT 서버]
    |
    |<--(SDP 오퍼 검색)--
    |
[앤서러]
    |
    |--(DHT에 SDP 앤서 저장: webrtc-answer)-->
    |
[DHT 서버]
    |
    |<--(SDP 앤서 검색)--
    |
[오퍼러]
    |
    |--(WebRTC 연결 설정)-->
    |
[피어 투 피어 데이터 채널]
```

## 커스터마이징

### 1. DHT 서버 세부 정보 변경

DHT 서버가 다른 호스트나 포트에서 실행 중인 경우:

- **오퍼러 및 앤서러**: `offerer_dhttype.py`와 `answerer_dhttype.py` 모두에서 `DHT_SERVER_HOST`와 `DHT_SERVER_PORT` 변수를 업데이트합니다.

```python
DHT_SERVER_HOST = "your_dht_server_ip"
DHT_SERVER_PORT = your_dht_server_port
```

### 2. DHT 키 수정

오퍼 및 앤서를 저장하기 위한 키를 변경하려면:

- **오퍼 키**: 두 스크립트 모두에서 `DHT_KEY_OFFER`를 변경합니다.
- **앤서 키**: 두 스크립트 모두에서 `DHT_KEY_ANSWER`를 변경합니다.

```python
DHT_KEY_OFFER = "your-offer-key"
DHT_KEY_ANSWER = "your-answer-key"
```

오퍼러와 앤서러가 동일한 키를 사용하여 통신하는지 확인하세요.

### 3. 다중 연결 처리

여러 WebRTC 연결을 처리하려면:

- **고유 키 사용**: 각 연결에 고유한 키를 사용하여 충돌을 방지합니다.
- **세션 관리**: 여러 SDP 교환을 관리하기 위해 세션 식별자를 구현합니다.

### 4. 데이터 채널 통신 강화

데이터 채널을 커스터마이징하여 다양한 유형의 데이터를 처리하거나 더 복잡한 상호작용을 위한 프로토콜을 구현할 수 있습니다.

## 문제 해결

### 일반적인 문제 및 해결 방법

#### 1. DHT 서버가 실행되지 않음

**증상**: 오퍼러 또는 앤서러가 DHT 서버에 연결할 수 없습니다.

**해결 방법**:
- `dht_server.py`가 오류 없이 실행 중인지 확인하세요.
- 오퍼러 및 앤서러 스크립트에서 호스트 및 포트 구성이 올바른지 확인하세요.
- DHT 서버 포트(`8468` 기본값)에 대한 방화벽 설정을 확인하여 트래픽을 허용합니다.

#### 2. SDP 오퍼 또는 앤서를 찾을 수 없음

**증상**: 스크립트가 SDP 데이터를 기다리며 무기한 대기합니다.

**해결 방법**:
- 오퍼러가 SDP 오퍼를 DHT에 성공적으로 저장했는지 확인한 후 앤서러를 시작하세요.
- 두 스크립트가 동일한 DHT 서버에 연결되어 있는지 확인하세요.
- 클라이언트와 DHT 서버 간의 네트워크 문제나 연결 문제를 확인하세요.

#### 3. WebRTC 연결 실패

**증상**: WebRTC 연결이 설정되지 않거나 데이터 채널이 열리지 않음.

**해결 방법**:
- 두 피어가 로컬 및 원격 설명을 성공적으로 설정했는지 확인하세요.
- WebRTC 피어 투 피어 연결을 차단할 수 있는 NAT 또는 방화벽 문제를 확인하세요.
- 오퍼러와 앤서러 스크립트가 호환 가능한 구성과 데이터 채널 레이블을 사용하고 있는지 확인하세요.

#### 4. Python 패키지 오류

**증상**: 누락된 패키지나 호환되지 않는 버전과 관련된 오류.

**해결 방법**:
- 필요한 모든 패키지(`kademlia`, `aiortc`)가 설치되었는지 확인하세요.
- Python 버전 호환성(Python 3.7 이상)을 확인하세요.
- 필요시 패키지를 재설치하세요:

```bash
pip install --upgrade kademlia aiortc
```

### 디버깅 팁

- **상세 로깅**: print 문을 추가하거나 로깅을 사용하여 실행 흐름을 추적하세요.
- **네트워크 모니터링**: `netstat`나 `Wireshark`와 같은 도구를 사용하여 네트워크 트래픽을 모니터링하고 연결 상태를 확인하세요.
- **분리 테스트**: 각 구성 요소를 개별적으로 테스트하여 문제가 발생하는 위치를 식별하세요(DHT 서버 연결을 독립적으로 테스트 등).

## 결론

이 매뉴얼은 Python을 사용하여 WebRTC 연결을 위한 DHT 기반 시그널링 시스템을 설정하는 데 필요한 단계를 제공합니다. 분산 해시 테이블을 활용함으로써 시그널링에 탈중앙화된 접근 방식을 제공하여 확장성과 안정성을 향상시킵니다. 제공된 스크립트를 커스터마이징하고 확장하여 특정 사용 사례에 맞게 조정하고, 문제 해결 섹션을 참조하여 일반적인 문제를 해결하세요.

추가적인 향상을 위해 인증 메커니즘 구현, 안전한 SDP 교환, 또는 다른 분산 기술과의 통합을 고려하여 견고한 실시간 통신 애플리케이션을 구축할 수 있습니다.

---

*DHT 기반 WebRTC 시그널링 시스템 설정에 대한 질문이 있거나 추가 지원이 필요하면 언제든지 문의해 주세요.*