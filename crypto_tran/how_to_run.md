# 블록체인 원장 시스템 매뉴얼

이 매뉴얼은 제공된 Python 스크립트를 사용하여 RSA 키 쌍을 생성하고, 트랜잭션을 생성 및 전송하며, 원장을 확인하는 방법을 안내합니다. 특히, 트랜잭션을 두 번 실행하여 원장의 이전 및 이후 트랜잭션의 해시가 올바르게 연결되어 있는지 확인하는 절차도 포함됩니다.

## 목차

- [블록체인 원장 시스템 매뉴얼](#블록체인-원장-시스템-매뉴얼)
  - [목차](#목차)
  - [사전 준비](#사전-준비)
  - [RSA 키 쌍 생성](#rsa-키-쌍-생성)
  - [트랜잭션 생성 및 전송](#트랜잭션-생성-및-전송)
    - [1. 첫 번째 트랜잭션 생성](#1-첫-번째-트랜잭션-생성)
    - [2. 두 번째 트랜잭션 생성](#2-두-번째-트랜잭션-생성)
  - [트랜잭션 수신 및 원장 업데이트](#트랜잭션-수신-및-원장-업데이트)
  - [원장 확인](#원장-확인)
  - [트랜잭션 해시 연결 확인](#트랜잭션-해시-연결-확인)
  - [문제 해결](#문제-해결)
    - [1. **키 생성 오류**](#1-키-생성-오류)
    - [2. **트랜잭션 서명 검증 실패**](#2-트랜잭션-서명-검증-실패)
    - [3. **원장 무결성 검증 실패**](#3-원장-무결성-검증-실패)
    - [4. **암호화/복호화 오류**](#4-암호화복호화-오류)
  - [결론](#결론)

---

## 사전 준비

- **Python 3.6 이상**이 설치되어 있어야 합니다.
- 필요한 라이브러리를 설치합니다. 터미널이나 명령 프롬프트에서 다음 명령어를 실행하세요:

  ```bash
  pip install cryptography
  ```

- 모든 스크립트 (`tools.py`, `create_keypair.py`, `create_transaction.py`, `receive_transaction.py`, `view_transactions.py`)를 동일한 디렉토리에 저장합니다.

---

## RSA 키 쌍 생성

각 사용자는 자신만의 RSA 키 쌍을 생성하여 트랜잭션을 서명하고 검증할 수 있습니다.

1. **키 생성 스크립트 실행:**

   ```bash
   python create_keypair.py <user_id>
   ```

   - `<user_id>`: 사용자 ID로, 영숫자 문자열이어야 합니다. 예를 들어, `badgirl` 또는 `goodboy`.

   **예시:**

   ```bash
   python create_keypair.py badgirl
   ```

2. **결과:**

   - `private_key_badgirl.pem`: `badgirl` 사용자의 비밀키 파일
   - `public_key_badgirl.pem`: `badgirl` 사용자의 공개키 파일

   마찬가지로, `goodboy` 사용자의 키를 생성하려면 다음과 같이 실행합니다:

   ```bash
   python create_keypair.py goodboy
   ```

---

## 트랜잭션 생성 및 전송

트랜잭션을 생성하여 송신자(`badgirl`)로부터 수신자(`goodboy`)에게 금액을 전송합니다. 이 절차를 두 번 반복하여 원장의 해시 연결을 확인할 수 있습니다.

### 1. 첫 번째 트랜잭션 생성

1. **트랜잭션 생성 스크립트 실행:**

   ```bash
   python create_transaction.py
   ```

2. **작동 방식:**

   - `badgirl` 사용자의 비밀키(`private_key_badgirl.pem`)를 로드합니다.
   - `goodboy` 사용자의 공개키(`public_key_goodboy.pem`)를 로드합니다.
   - 금액(예: 10.5)을 `goodboy`에게 전송하는 트랜잭션을 생성하고 서명합니다.
   - 트랜잭션 데이터를 대칭키로 암호화한 후, 대칭키를 `goodboy`의 공개키로 암호화합니다.
   - 암호화된 트랜잭션 데이터를 `encrypted_transaction.dat` 파일에 저장합니다.

3. **결과:**

   - `encrypted_transaction.dat`: 암호화된 트랜잭션 데이터 파일

### 2. 두 번째 트랜잭션 생성

위의 절차를 한 번 더 반복하여 두 번째 트랜잭션을 생성합니다. 단, 두 번째 트랜잭션의 `prev_hash`는 첫 번째 트랜잭션의 `current_hash`로 설정되어야 합니다.

1. **트랜잭션 생성 스크립트 실행:**

   ```bash
   python create_transaction.py
   ```

2. **결과:**

   - 두 번째 트랜잭션이 `encrypted_transaction.dat` 파일에 저장됩니다.

---

## 트랜잭션 수신 및 원장 업데이트

수신자인 `goodboy`는 수신된 트랜잭션을 복호화하고 원장에 추가합니다.

1. **수신 스크립트 실행:**

   ```bash
   python receive_transaction.py
   ```

2. **작동 방식:**

   - `goodboy` 사용자의 비밀키(`private_key_goodboy.pem`)를 로드합니다.
   - `encrypted_transaction.dat` 파일에서 암호화된 트랜잭션 데이터를 로드합니다.
   - 암호화된 대칭키를 `goodboy`의 비밀키로 복호화하여 대칭키를 얻습니다.
   - 대칭키로 트랜잭션 데이터를 복호화합니다.
   - 송신자(`badgirl`)의 공개키로 트랜잭션 서명을 검증합니다.
   - 트랜잭션의 해시를 계산하고, 이전 트랜잭션의 해시와 연결하여 원장에 추가합니다.
   - 원장의 무결성을 검증한 후, 원장을 암호화하여 저장합니다.

3. **결과:**

   - 원장이 업데이트되고, `ledger_goodboy.dat` 파일에 저장됩니다.

---

## 원장 확인

`view_transactions.py` 스크립트를 사용하여 원장에 저장된 트랜잭션을 확인할 수 있습니다.

1. **원장 확인 스크립트 실행:**

   ```bash
   python view_transactions.py
   ```

2. **작동 방식:**

   - `goodboy` 사용자의 비밀번호와 솔트를 사용하여 암호화 키를 유도합니다.
   - 암호화된 원장 파일(`ledger_goodboy.dat`)을 복호화하여 트랜잭션 목록을 로드합니다.
   - 트랜잭션 목록을 읽기 쉽게 출력합니다.

3. **결과:**

   - 원장에 저장된 모든 트랜잭션의 상세 정보가 출력됩니다.

---

## 트랜잭션 해시 연결 확인

트랜잭션을 두 번 실행한 후, 원장의 트랜잭션들이 올바르게 해시로 연결되어 있는지 확인하는 절차입니다.

1. **트랜잭션 두 번 실행:**

   위의 "트랜잭션 생성 및 전송" 절차를 두 번 반복하여 두 개의 트랜잭션을 원장에 추가합니다.

2. **원장 무결성 검증:**

   `receive_transaction.py` 스크립트는 트랜잭션을 원장에 추가할 때 자동으로 무결성을 검증합니다. 두 번째 트랜잭션이 추가될 때, 이전 트랜잭션의 `current_hash`가 새로운 트랜잭션의 `prev_hash`와 일치하는지 확인합니다.

3. **원장 확인:**

   `view_transactions.py`를 실행하여 원장에 저장된 트랜잭션을 확인합니다. 각 트랜잭션의 `prev_hash`와 `current_hash`가 올바르게 연결되어 있는지 확인할 수 있습니다.

   **예시 출력:**

   ```
   --- Transaction 1 ---
   Sender ID: badgirl
   Recipient ID: goodboy
   Amount: 10.5
   Timestamp: 2024-04-27T12:34:56.789123
   Previous Hash: 0000000000000000000000000000000000000000000000000000000000000000
   Current Hash: a1b2c3d4e5f67890abcdef1234567890abcdef1234567890abcdef1234567890
   Signature: <서명 데이터>
   -------------------------

   --- Transaction 2 ---
   Sender ID: badgirl
   Recipient ID: goodboy
   Amount: 5.25
   Timestamp: 2024-04-27T12:35:56.789123
   Previous Hash: a1b2c3d4e5f67890abcdef1234567890abcdef1234567890abcdef1234567890
   Current Hash: b2c3d4e5f67890abcdef1234567890abcdef1234567890abcdef1234567890ab
   Signature: <서명 데이터>
   -------------------------
   ```

   두 번째 트랜잭션의 `Previous Hash`가 첫 번째 트랜잭션의 `Current Hash`와 일치하는지 확인합니다.

---

## 문제 해결

### 1. **키 생성 오류**

- **문제:** `create_keypair.py` 실행 시 `user_id`가 영숫자가 아닌 경우 오류 발생.
- **해결:** `user_id`는 영숫자 문자열로 입력해야 합니다. 예: `goodboy123`

### 2. **트랜잭션 서명 검증 실패**

- **문제:** `receive_transaction.py` 실행 시 서명 검증이 실패하는 경우.
- **해결:**
  - 송신자의 공개키 파일(`public_key_<sender_id>.pem`)이 올바르게 로드되었는지 확인합니다.
  - 트랜잭션 데이터가 변조되지 않았는지 확인합니다.
  - 비밀키와 공개키가 올바르게 페어링되었는지 확인합니다.

### 3. **원장 무결성 검증 실패**

- **문제:** 원장 무결성 검증 시 오류 메시지가 출력되는 경우.
- **해결:**
  - 모든 트랜잭션의 `prev_hash`와 `current_hash`가 올바르게 연결되어 있는지 확인합니다.
  - 트랜잭션 생성 및 수신 과정에서 해시 계산이 올바르게 이루어졌는지 검토합니다.

### 4. **암호화/복호화 오류**

- **문제:** 트랜잭션 데이터 암호화 또는 복호화 시 오류 발생.
- **해결:**
  - 대칭키가 올바르게 생성되고 사용되었는지 확인합니다.
  - 암호화 및 복호화 시 사용되는 형식(`bytes` 또는 `hex`)이 일치하는지 확인합니다.

---

## 결론

이 매뉴얼을 통해 RSA 키 쌍을 생성하고, 트랜잭션을 생성 및 전송하며, 원장을 확인하는 전 과정을 이해할 수 있습니다. 특히, 트랜잭션을 두 번 실행하여 원장의 해시 연결을 확인함으로써 시스템의 무결성을 검증할 수 있습니다. 문제가 발생할 경우, 위의 문제 해결 섹션을 참고하여 문제를 해결하시기 바랍니다.